Короче, код рабочий (вроде бы рабочий: не проверялся учителем, не было много тестов, но так вроде работает), только проблемы с валгриндом я не разбирал в нём.
Но а прикол в том, что надо было сделать, чтобы очередь на векторе имела свойство переполняться. Ну и из-за этого условия мне пришлось вообще всё переделывать.
А ещё я в принципе улучшил код во второй попытке. Такие дела
