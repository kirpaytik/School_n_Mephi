Короче, незавершённая версия, если с санитайзером tsan запустить, то там не очень хорошо всё по дедлокам:)
Хотя вроде работает, но это, видимо, везенье

Но мне 1) лень исправлять, ибо и так есть норм версия; 2) идейно не получится исправить, ну или по крайней мере я сходу не вижу решения
